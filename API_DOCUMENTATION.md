# A366 Academic Assignment Platform - Complete API Documentation

**Document Version**: 1.0  
**Last Updated**: January 11, 2026  
**Backend Status**: Fully Implemented with RBAC, Audit Logging, and Notifications  

---

## Table of Contents

1. [Authentication & Authorization](#authentication--authorization)
2. [Global Requirements](#global-requirements)
3. [Client API (Backend Only)](#client-api-backend-only)
4. [BDE API](#bde-api)
5. [Writer API](#writer-api)
6. [Admin API](#admin-api)
7. [Error Handling & Status Codes](#error-handling--status-codes)
8. [Notification System](#notification-system)
9. [Audit Logging](#audit-logging)

---

## Authentication & Authorization

### JWT Token Structure

All requests (except `/auth/client/login` and OTP endpoints) require:

```
Authorization: Bearer <JWT_TOKEN>
```

**Token Payload:**
```json
{
  "user_id": 123,
  "role": "client|bde|writer|admin",
  "email": "user@example.com",
  "iat": 1234567890,
  "exp": 1234571490
}
```

### Token Generation (Client Login)

- **OTP-based login only** for clients
- JWT issued after email/mobile verification
- Token valid for 24 hours
- Refresh token mechanism (if configured)

---

## Global Requirements

### Request Headers (All Endpoints)

```
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json (or multipart/form-data for file uploads)
```

### Response Format (Standard)

```json
{
  "success": true,
  "message": "Operation successful",
  "data": { }
}
```

### RBAC Enforcement

- **Server-side only**: All role checks enforced at controller level
- **Frontend cannot bypass**: Token validation and role verification happen before controller execution
- **Token validation**: Happens in RBAC middleware
- **Role validation**: Each endpoint specifies allowed roles

---

# CLIENT API (Backend Only)

**Base Path**: `/client`  
**Authentication**: Required (Bearer token with `role: 'client'`)  
**Role**: Client only  

## 1. Authentication

### 1.1 Request OTP (Email)

```
POST /auth/client/otp/email
Content-Type: application/json
```

**Request Body:**
```json
{
  "email": "client@example.com"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "OTP sent to email",
  "data": {
    "otp_id": "email_123",
    "expires_in": 600
  }
}
```

**Validation:**
- Email must be registered
- OTP valid for 10 minutes
- Max 3 attempts per hour

---

### 1.2 Verify OTP & Get JWT

```
POST /auth/client/otp/verify
Content-Type: application/json
```

**Request Body:**
```json
{
  "email": "client@example.com",
  "otp": "123456"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "token": "eyJhbGc...",
    "user": {
      "user_id": 123,
      "email": "client@example.com",
      "role": "client",
      "is_verified": true
    }
  }
}
```

**Validation:**
- User must exist and have role = 'client'
- User must be verified (is_verified = 1)
- User must be active (is_active = 1)
- OTP must be correct
- OTP must not be expired

---

## 2. Profile Management

### 2.1 Get Profile

```
GET /client/profile
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "full_name": "John Doe",
    "email": "john@example.com",
    "mobile_number": "+1234567890",
    "whatsapp": "+1234567890",
    "university": "MIT",
    "currency_code": "USD",
    "country": "US",
    "is_verified": true,
    "created_at": "2026-01-01T10:00:00Z"
  }
}
```

---

### 2.2 Update Profile

```
PATCH /client/profile
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body (Any of these fields):**
```json
{
  "university": "Stanford",
  "currency_code": "GBP",
  "whatsapp": "+1234567899",
  "full_name": "John D"
}
```

**Protected Fields (Cannot be updated by client):**
- `role` - Only admin can change
- `bde` - Assigned by system
- `is_verified` - Set by admin only
- `referal_code` - Generated by system
- `password_hash` - Use security endpoints

**Response (200):**
```json
{
  "success": true,
  "message": "Profile updated successfully"
}
```

**RBAC:**
- Client can only update their own profile
- Enforced via `req.user.user_id` comparison

---

## 3. Query/Order Creation

### 3.1 Create Query

```
POST /client/queries
Authorization: Bearer <TOKEN>
Content-Type: multipart/form-data
```

**Request Body:**
```
paper_topic: "Effects of Climate Change on Ocean Ecosystems"
service: "Academic Writing"
subject: "Environmental Science"
urgency: "Standard"
description: "A comprehensive research paper on ocean acidification"
deadline_at: "2026-01-25T10:00:00Z"
currency_code: "USD" (optional, defaults to user's currency)
files: [attachment]
```

**Response (201):**
```json
{
  "success": true,
  "message": "Query created successfully",
  "data": {
    "order_id": 456,
    "query_code": "QUERY_ABC12345",
    "status": 1,
    "status_name": "Query Created",
    "work_code": null,
    "acceptance": 0,
    "created_at": "2026-01-11T10:00:00Z"
  }
}
```

**Database Changes:**
- `orders` table: New row with `work_code = NULL`, `acceptance = 0`, `status = 1`
- `file_versions`: Files uploaded by client
- `audit_logs`: Query creation logged
- `notifications`: Client notified

**Validation Rules:**
- All required fields must be present
- `deadline_at` must be in future (> now)
- Files must be valid formats and size < 50MB
- User must be verified and active

**RBAC:**
- Client role only

---

### 3.2 List My Queries

```
GET /client/queries?page=0&status=all&limit=20
Authorization: Bearer <TOKEN>
```

**Query Parameters:**
- `page`: 0-indexed page number (default: 0)
- `status`: Filter by status ID or 'all' (default: all)
- `limit`: Results per page, max 100 (default: 20)

**Response (200):**
```json
{
  "success": true,
  "data": {
    "queries": [
      {
        "order_id": 456,
        "query_code": "QUERY_ABC12345",
        "paper_topic": "Effects of Climate Change",
        "service": "Academic Writing",
        "subject": "Environmental Science",
        "urgency": "Standard",
        "deadline_at": "2026-01-25T10:00:00Z",
        "status": 1,
        "status_name": "Query Created",
        "acceptance": 0,
        "work_code": null,
        "created_at": "2026-01-11T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 0,
      "limit": 20,
      "total": 45,
      "pages": 3
    }
  }
}
```

**RBAC:**
- Client can only see their own queries (enforced via `user_id` filter)

---

### 3.3 Get Query Details

```
GET /client/queries/:orderId
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "query": {
      "order_id": 456,
      "query_code": "QUERY_ABC12345",
      "paper_topic": "Effects of Climate Change",
      "description": "A comprehensive research paper",
      "service": "Academic Writing",
      "subject": "Environmental Science",
      "urgency": "Standard",
      "deadline_at": "2026-01-25T10:00:00Z",
      "status": 3,
      "status_name": "Quotation Sent",
      "acceptance": 0,
      "work_code": null,
      "basic_price_usd": 200.00,
      "total_price_usd": null,
      "created_at": "2026-01-11T10:00:00Z"
    },
    "files": [
      {
        "id": 789,
        "file_name": "research_notes.pdf",
        "file_url": "/uploads/123_research_notes.pdf",
        "version_number": 1,
        "created_at": "2026-01-11T10:05:00Z"
      }
    ],
    "quotation": {
      "quotation_id": 100,
      "quoted_price_usd": 300.00,
      "tax": 30.00,
      "discount": 50.00,
      "notes": "Expedited delivery possible",
      "created_at": "2026-01-12T10:00:00Z"
    }
  }
}
```

**RBAC:**
- Client can only view their own queries

---

### 3.4 Edit Query (Denied)

```
PUT/PATCH /client/queries/:orderId
Authorization: Bearer <TOKEN>
```

**Response (403):**
```json
{
  "success": false,
  "message": "Client cannot edit query after creation. Contact support if changes needed."
}
```

**Enforcement:**
- Clients can never edit queries once created
- This prevents scope creep and audit complications

---

## 4. Quotation Management

### 4.1 View Quotation

```
GET /client/quotations/:orderId
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "quotation_id": 100,
    "order_id": 456,
    "quoted_price_usd": 300.00,
    "tax": 30.00,
    "discount": 50.00,
    "notes": "Expedited delivery available for +$50",
    "created_at": "2026-01-12T10:00:00Z"
  }
}
```

**RBAC:**
- Client can only view quotations for their own orders

---

### 4.2 Accept Quotation

```
POST /client/quotations/:orderId/accept
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Quotation accepted. Next, upload payment receipt."
}
```

**Database Changes:**
- `orders.acceptance` = 1
- Order status remains same (does NOT trigger work_code generation)
- `audit_logs`: Entry created
- `notifications`: Client notified

**State Machine Validation:**
- Order must have a quotation
- `acceptance` must be 0 (not already accepted)
- Cannot accept after payment already verified

**Next Step:**
- Client must upload payment receipt

---

## 5. Payment Management

### 5.1 Upload Payment Receipt

```
POST /client/payments/upload
Authorization: Bearer <TOKEN>
Content-Type: multipart/form-data
```

**Request Body:**
```
orderId: "456"
receipt: [attachment - PDF, JPG, PNG, max 10MB]
```

**Response (201):**
```json
{
  "success": true,
  "message": "Payment receipt uploaded successfully",
  "data": {
    "payment_id": 789,
    "status": "pending_verification",
    "created_at": "2026-01-13T10:00:00Z"
  }
}
```

**Database Changes:**
- `payments` table: New row created with `payment_method = 'manual_upload'`
- Payment is **ALWAYS** unverified initially
- `audit_logs`: Payment upload logged
- `notifications`: Admin notified (critical priority)

**Validation:**
- Order must exist and belong to client
- Quotation must be accepted (`acceptance = 1`)
- No previous payment for this order
- File must be valid format
- Amount must match quotation

**Critical Rules:**
- **Client CANNOT verify payment**
- **Only Admin can verify and generate work_code**
- Payment receipt saved but not processed

---

### 5.2 Get Payment Status

```
GET /client/payments/:orderId/status
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "payment_id": 789,
    "order_id": 456,
    "amount": 280.00,
    "payment_method": "manual_upload",
    "status": "pending",
    "created_at": "2026-01-13T10:00:00Z"
  }
}
```

**OR (Not submitted yet):**
```json
{
  "success": true,
  "data": {
    "status": "not_submitted",
    "message": "No payment has been submitted yet"
  }
}
```

**Status Values:**
- `pending`: Uploaded but not verified by Admin
- `verified`: Admin approved, work_code generated
- `not_submitted`: No payment receipt yet

---

## 6. Order Tracking (Confirmed Orders Only)

### 6.1 List Confirmed Orders

```
GET /client/orders?page=0&status=all&limit=20
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "order_id": 456,
        "query_code": "QUERY_ABC12345",
        "work_code": "WORK_XYZ987654",
        "paper_topic": "Effects of Climate Change",
        "service": "Academic Writing",
        "subject": "Environmental Science",
        "urgency": "Standard",
        "deadline_at": "2026-01-25T10:00:00Z",
        "status": 3,
        "status_name": "In Progress",
        "basic_price_usd": 200.00,
        "total_price_usd": 280.00,
        "has_submission": 1,
        "has_delivery": 0,
        "created_at": "2026-01-11T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 0,
      "limit": 20,
      "total": 15,
      "pages": 1
    }
  }
}
```

**Important:**
- Only shows orders with `work_code IS NOT NULL` (confirmed by Admin)
- Does NOT show query-stage orders

---

### 6.2 Track Order by Work Code

```
GET /client/orders/:workCode
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "order": {
      "order_id": 456,
      "query_code": "QUERY_ABC12345",
      "work_code": "WORK_XYZ987654",
      "paper_topic": "Effects of Climate Change",
      "service": "Academic Writing",
      "subject": "Environmental Science",
      "urgency": "Standard",
      "deadline_at": "2026-01-25T10:00:00Z",
      "status": 3,
      "status_name": "In Progress",
      "basic_price_usd": 200.00,
      "total_price_usd": 280.00,
      "words_used": 0,
      "pages_used": 0,
      "created_at": "2026-01-11T10:00:00Z",
      "timeRemaining": "336 hours"
    },
    "submission": {
      "submission_id": 101,
      "status": "pending_qc",
      "created_at": "2026-01-20T10:00:00Z",
      "updated_at": "2026-01-20T10:00:00Z"
    },
    "deliveryFiles": [
      {
        "id": 102,
        "file_name": "final_paper.pdf",
        "file_url": "/deliveries/work_xyz987654_final.pdf",
        "version_number": 1,
        "created_at": "2026-01-21T10:00:00Z"
      }
    ],
    "revisions": [
      {
        "id": 103,
        "revision_number": 1,
        "status": "pending",
        "deadline": "2026-01-28T10:00:00Z",
        "created_at": "2026-01-21T14:00:00Z"
      }
    ]
  }
}
```

**What Client Can See:**
- Order status and timeline
- Submission status (pending_qc, approved, revision_required, completed)
- Delivered files (once approved by Admin)
- Revision requests and their status

**What Client CANNOT See:**
- Writer identity
- QC scores (grammarly, AI, plagiarism)
- Internal notes or feedback
- Payment verification logic
- Task evaluations

---

### 6.3 Get Delivery Files

```
GET /client/orders/:orderId/delivery
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "files": [
      {
        "id": 102,
        "file_name": "final_paper.pdf",
        "file_url": "/deliveries/work_xyz987654_final.pdf",
        "version_number": 1,
        "created_at": "2026-01-21T10:00:00Z"
      }
    ]
  }
}
```

**Requirements:**
- Order must be in "delivered" or "completed" status
- Only shows final delivery files (not drafts)

---

## 7. Feedback & Revisions

### 7.1 Submit Feedback

```
POST /client/orders/:orderId/feedback
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "feedback": "The paper was well-structured but needs minor revisions in the conclusion",
  "rating": 4
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Feedback submitted successfully"
}
```

**Database Changes:**
- `revision_requests` table: Entry with `revision_number = 0`, `status = 'completed'` (feedback)
- `writer_ratings` table: Rating entry created/updated
- `audit_logs`: Feedback logged
- `notifications`: Admin notified

**Rating Scale:** 1-5 stars

---

### 7.2 Request Revision

```
POST /client/orders/:orderId/revision
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "reason": "Please improve the conclusion section - it's too brief",
  "deadline_at": "2026-01-30T10:00:00Z"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Revision request submitted successfully",
  "data": {
    "revision_id": 104,
    "revision_number": 1,
    "status": "pending"
  }
}
```

**Database Changes:**
- `revision_requests` table: New entry with `status = 'pending'`
- Next `revision_number` auto-incremented
- `audit_logs`: Revision request logged
- `notifications`: Admin notified (critical priority)

**Validation:**
- Deadline must be in future
- Order must be assigned to writer
- Order must be in deliverable state

**State Transitions:**
- Revision pending â†’ Writer accepts/rejects â†’ Writer submits â†’ Admin QC approval

---

### 7.3 Get Revision History

```
GET /client/orders/:orderId/revisions
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "revisions": [
      {
        "id": 104,
        "order_id": 456,
        "revision_number": 1,
        "status": "pending",
        "deadline": "2026-01-30T10:00:00Z",
        "created_at": "2026-01-21T14:00:00Z",
        "completed_at": null
      },
      {
        "id": 105,
        "order_id": 456,
        "revision_number": 2,
        "status": "completed",
        "deadline": "2026-02-02T10:00:00Z",
        "created_at": "2026-01-27T10:00:00Z",
        "completed_at": "2026-02-01T15:00:00Z"
      }
    ]
  }
}
```

---

## 8. Notifications

### 8.1 Get Notifications

```
GET /client/notifications?page=0&limit=50&unreadOnly=false
Authorization: Bearer <TOKEN>
```

**Query Parameters:**
- `page`: 0-indexed page (default: 0)
- `limit`: Per page, max 100 (default: 50)
- `unreadOnly`: true/false (default: false)

**Response (200):**
```json
{
  "success": true,
  "data": {
    "notifications": [
      {
        "notification_id": 200,
        "type": "success",
        "title": "Payment Verified",
        "message": "Your payment has been verified. Work code: WORK_XYZ987654",
        "link_url": "/client/orders/456",
        "is_read": false,
        "created_at": "2026-01-13T10:00:00Z"
      },
      {
        "notification_id": 201,
        "type": "info",
        "title": "Work Started",
        "message": "Your assignment has been started by the writer",
        "link_url": "/client/orders/456",
        "is_read": true,
        "created_at": "2026-01-14T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 0,
      "limit": 50,
      "total": 12,
      "unread": false
    }
  }
}
```

**Notification Types:**
- `success`: Positive state change (payment verified, delivery complete)
- `warning`: Needs attention (payment rejected, revision needed)
- `critical`: Urgent action needed (payment pending, deadline approaching)
- `info`: FYI updates (work started, submission received)

---

### 8.2 Mark Notification as Read

```
PATCH /client/notifications/:notificationId/read
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Response (200):**
```json
{
  "success": true,
  "message": "Notification marked as read"
}
```

---

## 9. Security Endpoints

### 9.1 Request Email OTP (Change Email)

```
POST /client/security/email/request-otp
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "new_email": "newemail@example.com"
}
```

---

### 9.2 Request Mobile OTP (Change Mobile)

```
POST /client/security/mobile/request-otp
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "new_mobile": "+1234567899"
}
```

---

### 9.3 Request Password Change OTP

```
POST /client/security/password/request-otp
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

---

---

# BDE API

**Base Path**: `/bde`  
**Authentication**: Required (Bearer token with `role: 'bde'`)  
**Rendering**: Server-side HTML (EJS views), not JSON APIs  

## 1. Dashboard & KPIs

### 1.1 Get Dashboard KPIs

```
GET /bde/dashboard/kpis
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "kpis": {
    "totalClients": 45,
    "activeQueries": 12,
    "pendingQuotations": 5,
    "confirmedOrders": 8,
    "thisMonthRevenue": 2500.00
  }
}
```

---

## 2. Client Management

### 2.1 List Assigned Clients

```
GET /bde/clients?page=1&limit=20
Authorization: Bearer <TOKEN>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "clients": [
      {
        "user_id": 123,
        "full_name": "John Doe",
        "email": "john@example.com",
        "country": "US",
        "total_orders": 5,
        "pending_queries": 2,
        "created_at": "2025-12-01T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "total": 45,
      "pages": 3
    }
  }
}
```

**RBAC:**
- BDE can ONLY see clients where `users.bde = bde_id`
- Client assignment immutable (cannot change)

---

## 3. Query Management

### 3.1 List Queries for BDE's Clients

```
GET /bde/queries?page=1&status=all
Authorization: Bearer <TOKEN>
```

**Status Filters:**
- `all`: All statuses
- `new`: New/unreviewed
- `review`: Under review
- `quotation_sent`: Quotation sent
- `awaiting_response`: Awaiting client response
- `closed`: Closed

**Response:**
```json
{
  "success": true,
  "data": {
    "queries": [
      {
        "order_id": 456,
        "query_code": "QUERY_ABC12345",
        "paper_topic": "Climate Change",
        "status": 1,
        "status_name": "New",
        "client": {
          "user_id": 123,
          "full_name": "John Doe",
          "email": "john@example.com"
        },
        "deadline_at": "2026-01-25T10:00:00Z",
        "created_at": "2026-01-11T10:00:00Z"
      }
    ]
  }
}
```

**RBAC:**
- BDE can ONLY see queries from their own clients
- Enforced via `users.bde = bde_id` join

---

### 3.2 View Query Details

```
GET /bde/queries/:queryCode
Authorization: Bearer <TOKEN>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "query": {
      "order_id": 456,
      "query_code": "QUERY_ABC12345",
      "paper_topic": "Climate Change",
      "service": "Academic Writing",
      "subject": "Environmental Science",
      "description": "...",
      "deadline_at": "2026-01-25T10:00:00Z",
      "status": 1,
      "client": {
        "user_id": 123,
        "full_name": "John Doe",
        "email": "john@example.com",
        "whatsapp": "+1234567890"
      },
      "files": [
        {
          "id": 789,
          "file_name": "research_notes.pdf",
          "file_url": "/uploads/...",
          "created_at": "2026-01-11T10:05:00Z"
        }
      ]
    }
  }
}
```

---

## 4. Quotation Generation

### 4.1 Generate Quotation

```
POST /bde/queries/:queryCode/quotation
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "base_price_usd": 200.00,
  "discount_usd": 50.00,
  "final_price_usd": 150.00,
  "notes": "Expedited delivery possible for additional $50"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Quotation generated successfully",
  "data": {
    "quotation_id": 100,
    "order_id": 456,
    "quoted_price_usd": 150.00,
    "created_at": "2026-01-12T10:00:00Z"
  }
}
```

**Database Changes:**
- `quotations` table: New entry created
- `orders.status` â†’ 3 (Quotation Sent)
- `audit_logs`: Quotation creation logged
- `notifications`: Client notified (success)

**Validation:**
- Query must exist and belong to BDE's client
- `final_price_usd` must be positive
- Query must not already have a quotation

**RBAC:**
- BDE can ONLY generate for their own clients

**Important:**
- Quotation does NOT generate work_code
- Only Admin can generate work_code (on payment verification)

---

## 5. Confirmed Orders (Read-Only)

### 5.1 List Confirmed Orders

```
GET /bde/orders?page=1&status=all
Authorization: Bearer <TOKEN>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "order_id": 456,
        "work_code": "WORK_XYZ987654",
        "query_code": "QUERY_ABC12345",
        "paper_topic": "Climate Change",
        "status": 3,
        "status_name": "In Progress",
        "deadline_at": "2026-01-25T10:00:00Z",
        "client": {
          "user_id": 123,
          "full_name": "John Doe"
        },
        "writer_assigned": true,
        "payment_verified": true,
        "total_price_usd": 280.00
      }
    ]
  }
}
```

**Permissions:**
- BDE can READ confirmed orders
- BDE CANNOT modify/cancel/reassign

---

## 6. Communication

### 6.1 Chat with Client

```
POST /bde/chat/:orderId
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "message": "Can you clarify the research methodology?"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Message sent"
}
```

**RBAC & Enforcement:**
- BDE can chat with their assigned clients ONLY
- BDE CANNOT chat with writers (direct communication not allowed)
- All messages logged and auditable

---

---

# WRITER API

**Base Path**: `/writer`  
**Authentication**: Required (Bearer token with `role: 'writer'`)  

## 1. Dashboard & KPIs

### 1.1 Get Dashboard KPIs

```
GET /writer/dashboard/kpis
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "kpis": {
    "newTasks": 3,
    "activeTasks": 8,
    "dueTodayTasks": 2,
    "completedTasks": 15
  }
}
```

---

## 2. Task Management

### 2.1 Get Pending Task Assignments

```
GET /writer/tasks?sortBy=deadline_at&order=ASC
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "tasks": [
    {
      "order_id": 456,
      "work_code": null,
      "topic": "Climate Change Effects",
      "service": "Academic Writing",
      "subject": "Environmental Science",
      "urgency": "Standard",
      "deadline_at": "2026-01-25T10:00:00Z",
      "description": "Research paper on ocean acidification",
      "assigned_at": "2026-01-11T10:00:00Z",
      "uploaded_documents_count": 3
    }
  ]
}
```

**Important:**
- Shows only tasks where writer has NOT yet responded
- Writer MUST accept or reject

---

### 2.2 Get Task Assignment Detail

```
GET /writer/tasks/:orderId
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "task": {
    "order_id": 456,
    "work_code": null,
    "paper_topic": "Climate Change",
    "service": "Academic Writing",
    "subject": "Environmental Science",
    "urgency": "Standard",
    "deadline_at": "2026-01-25T10:00:00Z",
    "description": "...",
    "documents": [
      {
        "id": 789,
        "file_name": "research_notes.pdf",
        "file_url": "/uploads/...",
        "file_size": 2048000,
        "created_at": "2026-01-11T10:05:00Z"
      }
    ]
  }
}
```

**What Writer CANNOT See:**
- Client identity/contact details
- Pricing information
- Payment status

---

### 2.3 Accept Task (Mark as DOABLE)

```
POST /writer/tasks/:orderId/accept
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "comment": "I can complete this within the deadline"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Task accepted successfully"
}
```

**Database Changes:**
- `task_evaluations` table: New entry with `status = 'doable'`
- `orders.status` â†’ 3 (In Progress)
- `audit_logs`: Acceptance logged
- `notifications`: Admin notified

**State Validation:**
- Writer must not have existing evaluation for this task
- No status skipping

---

### 2.4 Reject Task (Mark as NOT DOABLE)

```
POST /writer/tasks/:orderId/reject
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "reason": "Timeline is too tight for quality work"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Task rejected successfully"
}
```

**Database Changes:**
- `task_evaluations` table: New entry with `status = 'not_doable'`
- Order remains unassigned (Admin can reassign)
- `audit_logs`: Rejection logged
- `notifications`: Admin notified

---

## 3. Task Execution

### 3.1 Update Task Status

```
PATCH /writer/tasks/:workCode/status
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "status": "in_progress|under_review|submitted_for_qc"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Status updated"
}
```

**Valid Status Transitions:**
1. assigned â†’ in_progress (writer starts working)
2. in_progress â†’ under_review (writer ready for review)
3. under_review â†’ submitted_for_qc (formal submission)

**No Skipping:** Writer must follow sequence

---

## 4. File Upload & Submission

### 4.1 Upload Work File

```
POST /writer/tasks/:workCode/upload
Authorization: Bearer <TOKEN>
Content-Type: multipart/form-data
```

**Request Body:**
```
file: [attachment - PDF, DOCX, max 50MB]
version_notes: "Draft version with introduction and methodology"
```

**Response (201):**
```json
{
  "success": true,
  "message": "File uploaded successfully",
  "data": {
    "file_version": 2,
    "file_url": "/uploads/work_xyz987654_v2.pdf",
    "file_size": 1024000,
    "uploaded_at": "2026-01-20T10:00:00Z"
  }
}
```

**Database Changes:**
- `file_versions` table: New entry with `uploaded_by = writer_id`
- Version auto-incremented
- `audit_logs`: Upload logged

---

### 4.2 Submit for QC

```
POST /writer/tasks/:workCode/submit-qc
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "notes": "Final submission - all sections complete"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Submission sent for QC",
  "data": {
    "submission_id": 101,
    "status": "pending_qc",
    "submitted_at": "2026-01-20T15:00:00Z"
  }
}
```

**Database Changes:**
- `submissions` table: New entry with `status = 'pending_qc'`
- `orders.status` â†’ (pending_qc status ID)
- `audit_logs`: Submission logged
- `notifications`: Admin notified (critical - QC needed)

**State Machine:**
- Writer can ONLY submit after file upload
- Submission locks task from further writer edits
- Admin reviews for QC

---

## 5. Revision Handling

### 5.1 View Revision Request

```
GET /writer/tasks/:workCode/revisions
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "revisions": [
    {
      "id": 104,
      "revision_number": 1,
      "reason": "Please improve the conclusion section",
      "status": "pending",
      "deadline": "2026-01-30T10:00:00Z",
      "created_at": "2026-01-21T14:00:00Z"
    }
  ]
}
```

---

### 5.2 Accept Revision (Re-work)

```
POST /writer/tasks/:workCode/revisions/:revisionId/accept
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Response (200):**
```json
{
  "success": true,
  "message": "Revision accepted - you can now upload revised work"
}
```

---

### 5.3 Complete Revision

```
POST /writer/tasks/:workCode/revisions/:revisionId/complete
Authorization: Bearer <TOKEN>
Content-Type: multipart/form-data
```

**Request Body:**
```
revised_file: [attachment]
notes: "Improved conclusion and added recommendations"
```

**Response (201):**
```json
{
  "success": true,
  "message": "Revised work submitted for QC"
}
```

---

## 6. Communication (Admin Only)

### 6.1 Chat with Admin

```
POST /writer/chat/:orderId
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "message": "Client requirements clarification needed"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Message sent to admin"
}
```

**RBAC:**
- Writer can ONLY chat with Admin
- Writer CANNOT chat with Client directly
- All messages auditable

---

---

# ADMIN API

**Base Path**: `/admin`  
**Authentication**: Required (Bearer token with `role: 'admin'`)  
**Exclusive Authority**: Admin is the ONLY role that can:
- Verify payments and generate work_code
- Assign/reassign writers
- Approve/reject QC
- Override order states
- Restrict communications
- Access audit logs

## 1. Dashboard & KPIs

### 1.1 Get Dashboard KPIs

```
GET /admin/dashboard/kpis
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "kpis": {
    "totalUsers": 250,
    "activeQueries": 45,
    "pendingPayments": 8,
    "confirmedOrders": 125,
    "inProgressOrders": 87,
    "completedOrders": 200,
    "avgCompletionTime": "7.5 days",
    "thisMonthRevenue": 15000.00
  }
}
```

---

## 2. Query & Order Control

### 2.1 List All Queries

```
GET /admin/queries?page=1&status=all&bde_id=&client_id=
Authorization: Bearer <TOKEN>
```

**Query Parameters:**
- `page`: Page number
- `status`: Filter by status
- `bde_id`: Filter by BDE
- `client_id`: Filter by client

**Response:**
```json
{
  "success": true,
  "data": {
    "queries": [
      {
        "order_id": 456,
        "query_code": "QUERY_ABC12345",
        "paper_topic": "Climate Change",
        "status": 1,
        "status_name": "New",
        "client": {
          "user_id": 123,
          "full_name": "John Doe",
          "email": "john@example.com"
        },
        "bde": {
          "user_id": 10,
          "full_name": "BDE Manager"
        },
        "created_at": "2026-01-11T10:00:00Z"
      }
    ]
  }
}
```

---

### 2.2 View Query Details

```
GET /admin/queries/:queryCode
Authorization: Bearer <TOKEN>
```

---

## 3. Payment Verification (CRITICAL)

### 3.1 List Pending Payments

```
GET /admin/payments/pending?page=1&limit=20
Authorization: Bearer <TOKEN>
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "payments": [
      {
        "payment_id": 789,
        "order_id": 456,
        "query_code": "QUERY_ABC12345",
        "client": {
          "user_id": 123,
          "full_name": "John Doe",
          "email": "john@example.com"
        },
        "amount": 280.00,
        "total_price_usd": 280.00,
        "payment_doc": "receipt_123.pdf",
        "status": "pending",
        "created_at": "2026-01-13T10:00:00Z"
      }
    ]
  }
}
```

---

### 3.2 Verify Payment (Generate work_code)

```
POST /admin/payments/:paymentId/verify
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "payment_id": 789,
  "notes": "Receipt verified against bank statement",
  "approve": true
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Payment verified successfully",
  "data": {
    "payment_id": 789,
    "order_id": 456,
    "work_code": "WORK_XYZ987654",
    "status": "verified"
  }
}
```

**CRITICAL OPERATIONS:**
1. Validate payment matches order amount
2. Generate `work_code` (unique ID for confirmed order)
3. Update `orders.work_code = WORK_XYZ987654` (confirms order)
4. Deduct from client wallet (if configured)
5. Create order history entry
6. Audit log created
7. Notifications sent to client and admin

**Only Admin Can:**
- Verify payment
- Generate work_code
- Trigger order confirmation

**Validation:**
- Payment amount must match quotation (5% tolerance allowed)
- Order must exist
- Payment must not already be verified

**Atomic Transaction:**
- If any step fails, entire transaction rolled back
- Ensures data consistency

---

### 3.3 Reject Payment

```
POST /admin/payments/:paymentId/reject
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "payment_id": 789,
  "rejection_reason": "Receipt does not match order amount"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Payment rejected successfully",
  "data": {
    "payment_id": 789,
    "order_id": 456,
    "status": "rejected"
  }
}
```

**Database Changes:**
- Payment record deleted (if unverified)
- `audit_logs`: Rejection logged
- `notifications`: Client notified (warning)

**Client Next Step:**
- Must resubmit payment receipt

---

## 4. Writer Assignment

### 4.1 Assign Writer to Query

```
POST /admin/queries/:queryCode/assign-writer
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "writer_id": 567,
  "notes": "Best fit for this subject"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Writer assigned successfully"
}
```

**Database Changes:**
- `orders.writer_id = 567`
- `orders.status` â†’ (assigned status)
- `audit_logs`: Assignment logged
- `notifications`: Writer notified (task assignment)

---

### 4.2 Reassign Writer

```
POST /admin/orders/:orderId/reassign-writer
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "new_writer_id": 890,
  "reason": "Original writer unable to complete"
}
```

**Valid Reasons to Reassign:**
- Writer rejected task
- Writer unable to meet deadline
- Quality concerns
- Writer left platform

---

## 5. Quality Control (QC)

### 5.1 Get Submissions Pending QC

```
GET /admin/qc/pending?page=1&limit=20
Authorization: Bearer <TOKEN>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "submissions": [
      {
        "submission_id": 101,
        "order_id": 456,
        "work_code": "WORK_XYZ987654",
        "writer": {
          "user_id": 567,
          "full_name": "Jane Writer"
        },
        "file_url": "/uploads/work_xyz987654_final.pdf",
        "status": "pending_qc",
        "submitted_at": "2026-01-20T15:00:00Z"
      }
    ]
  }
}
```

---

### 5.2 Approve Submission (QC Pass)

```
POST /admin/orders/:workCode/qc/approve
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "qc_notes": "Excellent work - all requirements met",
  "grammarly_score": 85,
  "ai_score": 5,
  "plagiarism_score": 0
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Submission approved for delivery"
}
```

**Database Changes:**
- `submissions.status = 'approved'`
- QC scores saved to `orders` and `submissions`
- `orders.status` â†’ (approved status)
- `audit_logs`: QC approval logged
- `notifications`: Client notified (approved), Writer notified

**Next Step:**
- Order ready for delivery

---

### 5.3 Reject Submission (Request Revisions)

```
POST /admin/orders/:workCode/qc/reject
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "feedback": "Conclusion is too brief - needs expansion by 500 words",
  "revision_deadline": "2026-01-25T10:00:00Z"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Revision requested from writer"
}
```

**Database Changes:**
- `submissions.status = 'revision_required'`
- Feedback saved to `submissions.feedback`
- `revision_requests` created automatically
- `audit_logs`: Rejection logged
- `notifications`: Writer notified (revision needed), Client notified

---

## 6. Delivery & Closure

### 6.1 Deliver Order to Client

```
POST /admin/orders/:workCode/deliver
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "notes": "Final delivery - all requirements completed"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Order delivered to client"
}
```

**Database Changes:**
- `orders.status` â†’ (delivered status)
- Delivery files made accessible to client
- `audit_logs`: Delivery logged
- `notifications`: Client notified (delivery ready), Writer notified

---

### 6.2 Complete Order

```
POST /admin/orders/:workCode/complete
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "notes": "Order completed successfully"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Order marked as completed"
}
```

**Database Changes:**
- `orders.status` â†’ 5 (Completed)
- Order locked for further modifications
- `audit_logs`: Completion logged
- `notifications`: Client and Writer notified

**Completed Order Properties:**
- Read-only (no further edits)
- Can still view files
- Can still submit feedback/ratings
- Can request revisions (limited)

---

## 7. Audit & Monitoring

### 7.1 Get Audit Logs

```
GET /admin/audit-logs?page=1&limit=50&event_type=&user_id=
Authorization: Bearer <TOKEN>
```

**Query Parameters:**
- `event_type`: QUERY_CREATED, PAYMENT_VERIFIED, TASK_ACCEPTED, etc.
- `user_id`: Filter by user who triggered action
- `resource_type`: order, payment, submission, etc.

**Response (200):**
```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "id": 1000,
        "user_id": 123,
        "event_type": "QUERY_CREATED",
        "event_data": {
          "query_code": "QUERY_ABC12345",
          "paper_topic": "Climate Change"
        },
        "resource_type": "order",
        "resource_id": "456",
        "ip_address": "192.168.1.1",
        "details": "Client created query with code: QUERY_ABC12345",
        "created_at": "2026-01-11T10:00:00Z"
      }
    ]
  }
}
```

**Auditable Events:**
- QUERY_CREATED
- QUOTATION_GENERATED
- QUOTATION_ACCEPTED
- PAYMENT_UPLOADED
- PAYMENT_VERIFIED
- PAYMENT_REJECTED
- WRITER_ASSIGNED
- TASK_ACCEPTED
- TASK_REJECTED
- SUBMISSION_RECEIVED
- QC_APPROVED
- QC_REJECTED
- REVISION_REQUESTED
- ORDER_DELIVERED
- ORDER_COMPLETED
- FEEDBACK_SUBMITTED

---

### 7.2 Export Audit Logs

```
GET /admin/audit-logs/export?format=csv&filters=...
Authorization: Bearer <TOKEN>
```

**Supported Formats:**
- CSV
- PDF
- XLSX

---

## 8. System Overrides & Restrictions

### 8.1 Override Order Status

```
POST /admin/orders/:orderId/override-status
Authorization: Bearer <TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "new_status": 5,
  "reason": "Client requested expedited completion"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Order status overridden"
}
```

**CRITICAL:**
- Only use for exceptional circumstances
- Must be logged with reason
- Creates audit trail

---

---

# Error Handling & Status Codes

## HTTP Status Codes

| Code | Meaning | Example |
|------|---------|---------|
| 200 | OK - Request successful | Profile fetched, query created |
| 201 | Created - Resource created | Query created, payment uploaded |
| 400 | Bad Request - Invalid input | Missing required fields |
| 401 | Unauthorized - No/invalid token | Missing JWT token |
| 403 | Forbidden - Role not authorized | Client trying to verify payment |
| 404 | Not Found - Resource doesn't exist | Query not found |
| 409 | Conflict - State constraint violated | Accepting already-accepted quotation |
| 422 | Unprocessable Entity - Validation failed | Amount mismatch |
| 500 | Server Error - Unexpected error | Database connection error |

---

## Standard Error Response

```json
{
  "success": false,
  "message": "Error description",
  "errors": [
    {
      "field": "email",
      "message": "Email already registered"
    }
  ]
}
```

---

## Common Error Scenarios

### Client Trying to Verify Payment
```json
{
  "success": false,
  "message": "Access denied. Only Admin can verify payments."
}
```

### Invalid State Transition
```json
{
  "success": false,
  "message": "Cannot accept quotation. Quotation not found or already accepted."
}
```

### Payment Amount Mismatch
```json
{
  "success": false,
  "message": "Payment amount mismatch. Expected: 280.00, Received: 250.00"
}
```

---

# Notification System

## Notification Types

| Type | Color | Use Case |
|------|-------|----------|
| `success` | Green | Positive state changes (payment verified, delivery complete) |
| `warning` | Orange | Needs attention (payment rejected, revision needed, deadline approaching) |
| `critical` | Red | Urgent action (payment pending verification, work not submitted) |
| `info` | Blue | FYI updates (work started, message received) |

---

## Automatic Notification Triggers

### Client Notifications

| Event | Type | Title | Triggered By |
|-------|------|-------|--------------|
| Query created | success | "Query Created Successfully" | Client via POST /client/queries |
| Quotation received | info | "Quotation Ready for Review" | BDE via quotation generation |
| Quotation accepted | info | "Next: Upload Payment Receipt" | Client via POST /client/quotations/:id/accept |
| Payment uploaded | success | "Payment Receipt Uploaded" | Client via POST /client/payments/upload |
| Payment verified | success | "Payment Verified" | Admin via POST /admin/payments/:id/verify |
| Payment rejected | warning | "Payment Rejected" | Admin via POST /admin/payments/:id/reject |
| Work submitted for QC | info | "Work Submitted for Review" | Writer via POST /writer/tasks/:id/submit-qc |
| QC approved | success | "Work Approved for Delivery" | Admin via POST /admin/orders/:id/qc/approve |
| QC rejected | warning | "Revision Requested" | Admin via POST /admin/orders/:id/qc/reject |
| Revision requested | critical | "Revision Needed" | Client/Admin via revision request |
| Delivered | success | "Work Ready for Download" | Admin via POST /admin/orders/:id/deliver |
| Completed | success | "Order Completed" | Admin via POST /admin/orders/:id/complete |

### BDE Notifications
- Client query assigned
- Quotation accepted by client
- Payment uploaded (for tracking)

### Writer Notifications
- Task assigned
- Task rejection by admin
- QC feedback
- Revision requested
- Revision approved

### Admin Notifications
- Query created (critical)
- Payment uploaded (critical)
- QC submission ready (critical)
- Revision requested (critical)
- All status changes (info)

---

# Audit Logging

## What Gets Logged

**Critical Operations:**
- All authentication events (login, logout, token refresh)
- Query creation
- Quotation generation
- Payment upload/verification/rejection
- Writer assignment/reassignment
- Task acceptance/rejection
- Submission received
- QC approval/rejection
- Order delivery/completion
- Feedback submission
- Revision requests

**Log Entry Structure:**
```json
{
  "id": 1000,
  "user_id": 123,
  "event_type": "QUERY_CREATED",
  "event_data": {
    "query_code": "QUERY_ABC12345",
    "paper_topic": "Climate Change",
    "service": "Academic Writing"
  },
  "resource_type": "order",
  "resource_id": "456",
  "ip_address": "192.168.1.1",
  "user_agent": "Mozilla/5.0...",
  "action": "QUERY_CREATED",
  "details": "Client created query with code: QUERY_ABC12345",
  "created_at": "2026-01-11T10:00:00Z"
}
```

---

## Audit Log Query

```
SELECT 
  id, user_id, event_type, event_data, 
  resource_type, resource_id, ip_address, 
  details, created_at
FROM audit_logs
WHERE event_type IN (...)
  AND created_at BETWEEN ? AND ?
ORDER BY created_at DESC
```

---

# Implementation Checklist

## âœ… Completed

- [x] Client API endpoints (queries, quotations, payments, orders, feedback, notifications)
- [x] BDE API endpoints (clients, queries, quotations)
- [x] Writer API endpoints (tasks, submissions, revisions)
- [x] Admin API endpoints (payment verification, QC, delivery)
- [x] RBAC enforcement at middleware & controller level
- [x] Audit logging for all critical actions
- [x] Notification system (server-triggered)
- [x] Payment verification with work_code generation (Admin only)
- [x] State machine validation (no status skipping)
- [x] Query-to-confirmed-order flow
- [x] Writer task evaluation workflow
- [x] Revision request handling
- [x] File versioning

## ðŸ”„ Integration Points

1. **Frontend Integration:**
   - All endpoints expect Bearer token in Authorization header
   - RBAC enforced server-side (frontend cannot bypass)
   - Role-based UI should request role from `/client/profile`, etc.

2. **Payment Processing:**
   - Manual receipt upload only (no automated processor)
   - Admin manually verifies receipt
   - work_code generated ONLY on Admin verification

3. **Notifications:**
   - Client-side should poll `/client/notifications`
   - Or use WebSocket for real-time updates (if implemented)

4. **Audit Trail:**
   - All operations logged automatically
   - Admin can export audit logs for compliance

---

# Security Enforcement (Server-Side Only)

1. **No Frontend Logic:** Backend is single source of truth
2. **Token Validation:** Every request validates JWT
3. **Role Checks:** Each endpoint enforces allowed roles
4. **Data Ownership:** Queries and orders scoped to user_id
5. **State Validation:** Status transitions strictly enforced
6. **Atomic Transactions:** Payment verification uses database transactions
7. **Audit Trail:** Every action logged
8. **No Secrets Exposed:** Frontend never sees sensitive data (writer identity, QC scores, payment verification logic)

---

**End of API Documentation**

