<%- include('../../partials/head.ejs') %>

<section class="space-y-6">

  <!-- PAGE HEADER -->
  <div>
    <h1 class="text-3xl font-black text-slate-800">Client Details</h1>
    <p class="text-slate-500 mt-2">Manage communication and track queries for this client</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- CLIENT INFO -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-black">
            <%= client.full_name.charAt(0) %>
          </div>
          <div>
            <h2 class="text-xl font-black text-slate-800"><%= client.full_name %></h2>
            <p class="text-slate-500 text-sm"><%= client.country %></p>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <p class="text-xs text-slate-500 font-semibold uppercase mb-1">Email</p>
            <p class="text-slate-800 font-semibold"><%= client.email %></p>
          </div>
          <div>
            <p class="text-xs text-slate-500 font-semibold uppercase mb-1">WhatsApp</p>
            <% if (client.whatsapp) { %>
              <a href="https://wa.me/<%= client.whatsapp.replace(/\D/g, '') %>" target="_blank" class="text-green-600 hover:underline font-semibold">
                <i class="fi fi-brands-whatsapp"></i> <%= client.whatsapp %>
              </a>
            <% } else { %>
              <p class="text-slate-400">Not provided</p>
            <% } %>
          </div>
          <div>
            <p class="text-xs text-slate-500 font-semibold uppercase mb-1">University</p>
            <p class="text-slate-800"><%= client.university || 'Not provided' %></p>
          </div>
          <div class="pt-4 border-t border-slate-200">
            <a href="https://wa.me/<%= client.whatsapp ? client.whatsapp.replace(/\D/g, '') : client.mobile_number.replace(/\D/g, '') %>" target="_blank" class="w-full block text-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
              <i class="fi fi-brands-whatsapp"></i> Start Chat
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- QUERIES & MESSAGES -->
    <div class="lg:col-span-2 space-y-6">

      <!-- QUERIES SECTION -->
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <h3 class="text-lg font-black text-slate-800 mb-4">Client Queries</h3>
        
        <% if (queries && queries.length > 0) { %>
          <div class="space-y-3">
            <% queries.forEach(query => { %>
              <a href="/bde/queries/<%= query.query_code %>" class="block p-4 bg-slate-50 rounded-lg border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition">
                <div class="flex items-start justify-between">
                  <div>
                    <p class="font-semibold text-slate-800"><%= query.paper_topic.substring(0, 50) %></p>
                    <p class="text-sm text-slate-500 mt-1">Query Code: <span class="font-mono font-semibold"><%= query.query_code %></span></p>
                  </div>
                  <span class="px-3 py-1 text-xs font-semibold rounded-full
                    <% if (query.status === 1) { %>bg-blue-100 text-blue-700<% } %>
                    <% if (query.status === 2) { %>bg-yellow-100 text-yellow-700<% } %>
                    <% if (query.status === 3) { %>bg-orange-100 text-orange-700<% } %>
                    <% if (query.status === 4) { %>bg-purple-100 text-purple-700<% } %>
                    <% if (query.status === 5) { %>bg-red-100 text-red-700<% } %>
                    <% if (query.status === 6) { %>bg-green-100 text-green-700<% } %>
                  ">
                    <% 
                    const statusMap = {1: 'New', 2: 'Under Review', 3: 'Quotation Sent', 4: 'Awaiting Response', 5: 'Closed', 6: 'Confirmed'};
                    %>
                    <%= statusMap[query.status] || 'Unknown' %>
                  </span>
                </div>
                <div class="mt-2 text-xs text-slate-500">
                  <span><i class="fi fi-rr-calendar"></i> <%= new Date(query.created_at).toLocaleDateString() %></span>
                  <span class="ml-4"><i class="fi fi-rr-clock"></i> Deadline: <%= new Date(query.deadline_at).toLocaleDateString() %></span>
                </div>
              </a>
            <% }); %>
          </div>
        <% } else { %>
          <p class="text-center text-slate-400 py-6">No queries from this client yet</p>
        <% } %>
      </div>

      <!-- MESSAGES SECTION -->
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <h3 class="text-lg font-black text-slate-800 mb-4">Recent Messages</h3>
        
        <% if (messages && messages.length > 0) { %>
          <div class="space-y-3 max-h-80 overflow-y-auto">
            <% messages.forEach(msg => { %>
              <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                <p class="text-sm text-slate-700"><%= msg.message %></p>
                <p class="text-xs text-slate-400 mt-1"><%= new Date(msg.created_at).toLocaleString() %></p>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <p class="text-center text-slate-400 py-6">No messages yet</p>
        <% } %>
      </div>

    </div>

  </div>

</section>
