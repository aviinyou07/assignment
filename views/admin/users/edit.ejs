<section class="space-y-6">

  <!-- HEADER -->
  <div class="flex items-center gap-4 mb-4">
    <a href="/admin/users/<%= user.user_id %>/view" class="text-indigo-600 hover:text-indigo-700 font-bold flex items-center gap-2">
      <i class="fi fi-rr-arrow-left"></i> Back
    </a>
    <h1 class="text-3xl font-black text-slate-800">Edit User: <%= user.full_name %></h1>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- LEFT: FORM -->
    <div class="lg:col-span-2 space-y-6">

      <!-- EDIT FORM -->
      <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
        <h3 class="text-lg font-black text-slate-800 mb-6 pb-4 border-b border-slate-200 flex items-center gap-2">
          <i class="fi fi-rr-user-gear text-indigo-600"></i>
          Personal Information
        </h3>

        <form id="editUserForm" class="space-y-6">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Full Name *</label>
              <input 
                type="text" 
                name="full_name"
                value="<%= user.full_name %>"
                required
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Email *</label>
              <input 
                type="email" 
                name="email"
                value="<%= user.email %>"
                required
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Mobile Number</label>
              <input 
                type="tel" 
                name="mobile_number"
                value="<%= user.mobile_number || '' %>"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">WhatsApp</label>
              <input 
                type="tel" 
                name="whatsapp"
                value="<%= user.whatsapp || '' %>"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">University</label>
              <input 
                type="text" 
                name="university"
                value="<%= user.university || '' %>"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Country</label>
              <input 
                type="text" 
                name="country"
                value="<%= user.country || '' %>"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Currency Code</label>
              <input 
                type="text" 
                name="currency_code"
                maxlength="3"
                value="<%= user.currency_code || '' %>"
                placeholder="USD"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Referral Code</label>
              <input 
                type="text" 
                name="referal_code"
                value="<%= user.referal_code || '' %>"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Role *</label>
              <select name="role" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="client" <%= user.role === 'client' ? 'selected' : '' %>>Client</option>
                <option value="writer" <%= user.role === 'writer' ? 'selected' : '' %>>Writer</option>
                <option value="bde" <%= user.role === 'bde' ? 'selected' : '' %>>BDE</option>
                <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>Admin</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 mb-2 block">Assigned BDE (User ID)</label>
              <input 
                type="number" 
                name="bde"
                value="<%= user.bde || '' %>"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
            </div>

          </div>

        </form>
      </div>

      <!-- STATUS SECTION -->
      <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
        <h3 class="text-lg font-black text-slate-800 mb-6 pb-4 border-b border-slate-200 flex items-center gap-2">
          <i class="fi fi-rr-shield-check text-indigo-600"></i>
          Account Status
        </h3>

        <form id="statusForm" class="space-y-4">
          
          <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
            <div>
              <p class="font-bold text-slate-800">Active Account</p>
              <p class="text-sm text-slate-500">Is this user account active?</p>
            </div>
            <div class="ml-auto">
              <input 
                type="checkbox" 
                id="isActive"
                <%= user.is_active ? 'checked' : '' %>
                class="w-6 h-6 rounded-lg"
              >
            </div>
          </div>

          <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
            <div>
              <p class="font-bold text-slate-800">Email Verified</p>
              <p class="text-sm text-slate-500">Has this user verified their email?</p>
            </div>
            <div class="ml-auto">
              <input 
                type="checkbox" 
                id="isVerified"
                <%= user.is_verified ? 'checked' : '' %>
                class="w-6 h-6 rounded-lg"
              >
            </div>
          </div>

        </form>
      </div>

      <!-- BUTTONS -->
      <div class="flex gap-4">
        <button type="button" onclick="updateUser()" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
          <i class="fi fi-rr-check"></i> Save Changes
        </button>
        <a href="/admin/users/<%= user.user_id %>/view" class="flex-1 bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300 transition-all flex items-center justify-center gap-2">
          <i class="fi fi-rr-cross"></i> Cancel
        </a>
      </div>

    </div>

    <!-- RIGHT: INFO PANEL -->
    <div class="space-y-6">

      <!-- USER ID CARD -->
      <div class="bg-gradient-to-br from-indigo-600 to-violet-600 rounded-2xl p-6 text-white shadow-lg">
        <p class="text-indigo-100 text-xs font-bold uppercase mb-2">User ID</p>
        <p class="font-mono font-black text-2xl"><%= user.user_id %></p>
      </div>

      <!-- ACCOUNT INFO -->
      <div class="bg-white p-6 rounded-2xl border border-slate-200">
        <h4 class="font-bold text-slate-800 mb-4">Account Information</h4>
        <div class="space-y-3 text-sm">
          <div>
            <p class="text-slate-500 text-xs uppercase font-bold mb-1">Joined</p>
            <p class="text-slate-800 font-bold"><%= new Date(user.created_at).toLocaleDateString() %></p>
          </div>
          <div>
            <p class="text-slate-500 text-xs uppercase font-bold mb-1">Current Role</p>
            <p class="text-slate-800 font-bold capitalize"><%= user.role %></p>
          </div>
          <% if (user.referal_code) { %>
            <div>
              <p class="text-slate-500 text-xs uppercase font-bold mb-1">Referral Code</p>
              <p class="text-slate-800 font-bold"><%= user.referal_code %></p>
            </div>
          <% } %>
        </div>
      </div>

    </div>

  </div>

</section>

<script>
  async function updateUser() {
    const form = document.getElementById('editUserForm');
    const statusForm = document.getElementById('statusForm');
    const isActive = document.getElementById('isActive').checked;
    const isVerified = document.getElementById('isVerified').checked;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.is_active = isActive;
    data.is_verified = isVerified;

    try {
      const response = await fetch('/admin/users/<%= user.user_id %>/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        showNotification('User updated successfully', 'success');
        setTimeout(() => window.location.href = '/admin/users/<%= user.user_id %>/view', 1500);
      } else {
        showNotification(result.message || 'Failed to update user', 'error');
      }
    } catch (err) {
      console.error('Update error:', err);
      showNotification('An error occurred', 'error');
    }
  }

  function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-xl font-bold text-white z-50 animate-in slide-in-from-top ${
      type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);

    setTimeout(() => alertDiv.remove(), 4000);
  }
</script>
