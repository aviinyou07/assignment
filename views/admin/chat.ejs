<section class="space-y-6">
  <div class="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-2xl p-7 text-white shadow-lg flex items-center justify-between">
    <div>
      <p class="text-sm uppercase tracking-[0.2em] font-bold text-white/70">Messaging Hub</p>
      <h1 class="text-3xl font-black mt-1">Chats by role</h1>
      <p class="text-indigo-100 text-sm mt-2">Quickly switch between client, BDE, and writer conversations. Admins can view and reply everywhere.</p>
    </div>
    <div class="hidden md:flex gap-3">
      <button id="refresh-chats" class="px-4 py-2 bg-white/15 hover:bg-white/25 text-white font-semibold rounded-xl text-sm transition flex items-center gap-2">
        <i class="fi fi-rr-rotate-right text-sm"></i>
        Refresh
      </button>
      <button onclick="openGlobalChat()" class="px-4 py-2 bg-white text-indigo-700 font-semibold rounded-xl text-sm shadow-md flex items-center gap-2">
        <i class="fi fi-rr-messages"></i>
        Open Inbox
      </button>
    </div>
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm">
    <div class="border-b border-slate-100 flex items-center justify-between px-4 sm:px-6 py-3 gap-4 flex-wrap">
      <div class="flex gap-2">
        <button data-filter="clients" class="chat-tab active px-4 py-2 rounded-lg font-semibold text-sm bg-indigo-50 text-indigo-700 border border-indigo-100">Clients</button>
        <button data-filter="bde" class="chat-tab px-4 py-2 rounded-lg font-semibold text-sm text-slate-600 hover:bg-slate-50 border border-transparent">BDE</button>
        <button data-filter="writers" class="chat-tab px-4 py-2 rounded-lg font-semibold text-sm text-slate-600 hover:bg-slate-50 border border-transparent">Writers</button>
        <button data-filter="bde-client" class="chat-tab px-4 py-2 rounded-lg font-semibold text-sm text-slate-600 hover:bg-slate-50 border border-transparent">BDE ↔ Client</button>
      </div>
      <div class="flex items-center gap-2">
        <div class="relative">
          <i class="fi fi-rr-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
          <input id="chat-search" type="text" placeholder="Search by name or code" class="pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <button id="refresh-chats-mobile" class="md:hidden px-3 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-semibold">
          <i class="fi fi-rr-rotate-right"></i>
        </button>
      </div>
    </div>

    <div class="p-4 sm:p-6">
      <div id="chat-list" class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        <div class="col-span-full text-center py-10 text-slate-400">
          <i class="fi fi-rr-spinner-alt animate-spin text-2xl mb-2 block"></i>
          Loading conversations...
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function () {

  /* =====================================================
     ADMIN CHAT — HARD ASSERT
  ===================================================== */
  const CURRENT_ROLE = 'admin'; // this page is ADMIN ONLY
  if (CURRENT_ROLE !== 'admin') {
    console.error('Unauthorized access to admin chat UI');
    return;
  }

  const state = {
    conversations: [],
    filter: 'clients',
    search: ''
  };

  document.addEventListener('DOMContentLoaded', () => {
    bindTabs();
    bindSearch();
    bindRefresh();
    loadConversations();
  });

  /* =====================================================
     UI BINDINGS
  ===================================================== */
  function bindTabs() {
    document.querySelectorAll('.chat-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chat-tab')
          .forEach(b => b.classList.remove('active', 'bg-indigo-50', 'text-indigo-700', 'border-indigo-100'));

        btn.classList.add('active', 'bg-indigo-50', 'text-indigo-700', 'border-indigo-100');
        state.filter = btn.dataset.filter;
        renderList();
      });
    });
  }

  function bindSearch() {
    const search = document.getElementById('chat-search');
    if (!search) return;

    search.addEventListener('input', e => {
      state.search = e.target.value.toLowerCase();
      renderList();
    });
  }

  function bindRefresh() {
    ['refresh-chats', 'refresh-chats-mobile'].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.addEventListener('click', loadConversations);
    });
  }

  /* =====================================================
     DATA LOADING
  ===================================================== */
  async function loadConversations() {
    const container = document.getElementById('chat-list');
    container.innerHTML = loaderHtml();

    try {
      const res = await fetch('/chat/my-conversations', { credentials: 'include' });
      const data = await res.json();

      if (!data.success) throw new Error(data.message || 'Failed');

      state.conversations = data.conversations || [];
      renderList();
    } catch (err) {
      console.error('Chat load error:', err);
      container.innerHTML = errorHtml();
    }
  }

  /* =====================================================
     RENDERING
  ===================================================== */
  function renderList() {
    const container = document.getElementById('chat-list');

    const filtered = state.conversations
      .map(conv => ({ ...conv, bucket: categorize(conv) }))
      .filter(conv => conv.bucket === state.filter)
      .filter(conv => {
        if (!state.search) return true;
        const hay = `${conv.display_name || ''} ${conv.context_code || ''} ${conv.last_message || ''}`.toLowerCase();
        return hay.includes(state.search);
      });

    if (!filtered.length) {
      container.innerHTML = emptyHtml();
      return;
    }

    container.innerHTML = filtered.map(renderCard).join('');
  }

  /* =====================================================
     ENTERPRISE-SAFE CATEGORIZATION (ADMIN VIEW)
  ===================================================== */
  function categorize(conv) {
    if (conv.has_writer && conv.has_admin) return 'writers';
    if (conv.has_bde && conv.has_admin && !conv.has_client) return 'bde';
    if (conv.has_client && conv.has_admin && !conv.has_bde) return 'clients';
    if (conv.has_bde && conv.has_client && !conv.has_admin) return 'bde-client';
    return 'clients'; // safe default for admin
  }

  function renderCard(conv) {
    const initials = getInitials(conv);
    const lastTime = conv.last_message_at ? formatTimeAgo(conv.last_message_at) : 'No messages yet';
    const unread = Number(conv.unread_count) > 0;

    const badgeMap = {
      'clients': 'Client',
      'bde': 'BDE',
      'writers': 'Writer',
      'bde-client': 'BDE ↔ Client'
    };

    const badgeStyle = {
      'clients': 'bg-emerald-50 text-emerald-700',
      'bde': 'bg-amber-50 text-amber-700',
      'writers': 'bg-purple-50 text-purple-700',
      'bde-client': 'bg-indigo-50 text-indigo-700'
    };

    return `
      <div class="border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition relative">
        ${unread ? unreadBadge(conv.unread_count) : ''}

        <div class="flex items-center gap-3 mb-3">
          <div class="w-11 h-11 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-black">
            ${initials}
          </div>
          <div class="min-w-0 flex-1">
            <p class="font-bold text-slate-800 truncate">${escapeHtml(conv.display_name || conv.context_code)}</p>
            <p class="text-xs text-slate-500 truncate">${escapeHtml(conv.role_label || '')}</p>
          </div>
          <span class="text-[11px] px-2 py-1 rounded-full ${badgeStyle[conv.bucket]} font-semibold">
            ${badgeMap[conv.bucket]}
          </span>
        </div>

        <p class="text-sm text-slate-600 line-clamp-2 mb-3">
          ${escapeHtml(conv.last_message || 'No messages yet')}
        </p>

        <div class="flex items-center justify-between text-xs text-slate-500">
          <span>${escapeHtml(conv.context_code || '')}</span>
          <span>${lastTime}</span>
        </div>

        <button class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-indigo-700 transition"
          onclick="openChatFromAdmin('${conv.context_code}', '${escapeHtmlAttr(conv.display_name || conv.context_code)}')">
          View & reply
        </button>
      </div>
    `;
  }

  /* =====================================================
     ADMIN OPEN CHAT
  ===================================================== */
  window.openChatFromAdmin = function (contextCode, title) {
    openGlobalChat();
    setTimeout(() => {
      if (typeof openConversation === 'function') {
        openConversation(contextCode, title);
      }
    }, 300);
  };

  /* =====================================================
     HELPERS
  ===================================================== */
  function getInitials(conv) {
    const base = conv.display_name || conv.context_code || 'A';
    return base.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
  }

  function unreadBadge(count) {
    return `<span class="absolute top-3 right-3 bg-indigo-600 text-white text-[10px] font-bold rounded-full min-w-[20px] h-5 px-2 flex items-center justify-center">${count}</span>`;
  }

  function loaderHtml() {
    return `<div class="col-span-full text-center py-10 text-slate-400">
      <i class="fi fi-rr-spinner-alt animate-spin text-2xl mb-2 block"></i>Loading conversations...
    </div>`;
  }

  function emptyHtml() {
    return `<div class="col-span-full text-center py-10 text-slate-400">
      <i class="fi fi-rr-comment text-3xl mb-2 block"></i>No conversations in this tab
    </div>`;
  }

  function errorHtml() {
    return `<div class="col-span-full text-center py-10 text-red-400">
      <i class="fi fi-rr-exclamation text-2xl mb-2 block"></i>Unable to load conversations
    </div>`;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  function escapeHtmlAttr(str) {
    return (str || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  function formatTimeAgo(dateStr) {
    const diff = Date.now() - new Date(dateStr).getTime();
    const m = Math.floor(diff / 60000);
    if (m < 1) return 'just now';
    if (m < 60) return `${m}m ago`;
    const h = Math.floor(m / 60);
    if (h < 24) return `${h}h ago`;
    const d = Math.floor(h / 24);
    return `${d}d ago`;
  }

})();
</script>
