<div class="min-h-screen bg-gray-50 py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Final Delivery</h1>
      <p class="mt-2 text-gray-600">Deliver approved submissions to customers</p>
    </div>

    <!-- Filter -->
    <div class="mb-6 flex gap-4">
      <select id="statusFilter" class="border rounded px-4 py-2" onchange="filterByStatus(this.value)">
        <option value="approved">Approved (Ready to Deliver)</option>
        <option value="delivered">Already Delivered</option>
        <option value="all">All</option>
      </select>
    </div>

    <!-- Delivery List -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Work Code</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Topic</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Writer</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">File</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Submitted</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (submissions && submissions.length > 0) { %>
              <% submissions.forEach(sub => { %>
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-6 py-4 font-medium"><%= sub.query_code %></td>
                  <td class="px-6 py-4"><%= sub.paper_topic %></td>
                  <td class="px-6 py-4"><%= sub.writer_name %></td>
                  <td class="px-6 py-4">
                    <% if (sub.file_url) { %>
                      <a href="/uploads/<%= sub.file_url %>" class="text-blue-600 hover:text-blue-900 flex items-center" target="_blank">
                        <i class="fi fi-rr-document mr-1"></i> Download
                      </a>
                    <% } else { %>
                      <span class="text-gray-400">No file</span>
                    <% } %>
                  </td>
                  <td class="px-6 py-4">
                    <% 
                      const statusColors = {
                        'approved': 'bg-green-100 text-green-800',
                        'completed': 'bg-blue-100 text-blue-800',
                        'pending_qc': 'bg-yellow-100 text-yellow-800'
                      };
                    %>
                    <span class="inline-block <%= statusColors[sub.status] || 'bg-gray-100 text-gray-800' %> text-xs px-2 py-1 rounded">
                      <%= sub.status === 'approved' ? 'Approved' : sub.status === 'completed' ? 'Delivered' : sub.status %>
                    </span>
                  </td>
                  <td class="px-6 py-4"><%= new Date(sub.created_at).toLocaleDateString() %></td>
                  <td class="px-6 py-4">
                    <% if (sub.status === 'approved') { %>
                      <button onclick="deliverFile(<%= sub.submission_id %>)" class="text-indigo-600 hover:text-indigo-900 text-sm mr-3">
                        <i class="fi fi-rr-paper-plane"></i> Deliver
                      </button>
                    <% } %>
                    <button onclick="viewHistory(<%= sub.submission_id %>)" class="text-gray-600 hover:text-gray-900 text-sm">
                      History
                    </button>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="7" class="px-6 py-12 text-center text-gray-400">
                  <i class="fi fi-rr-inbox text-4xl block mb-2"></i>
                  <p>No submissions ready for delivery</p>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Delivery Modal -->
<div id="deliveryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
    <div class="border-b px-6 py-4">
      <h2 class="text-xl font-bold">Deliver File to Customer</h2>
    </div>

    <form id="deliveryForm" class="p-6 space-y-4">
      <input type="hidden" id="submissionId">
      
      <div class="bg-blue-50 border border-blue-200 rounded p-4">
        <p class="text-sm"><strong>Note:</strong> The approved file will be delivered to the customer and the order will be locked from further edits.</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Notes (Optional)</label>
        <textarea id="deliveryNotes" class="w-full border rounded px-3 py-2 h-20" placeholder="Any notes for the customer..."></textarea>
      </div>

      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button type="button" onclick="closeDeliveryModal()" class="px-4 py-2 text-gray-700 border rounded hover:bg-gray-50">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Confirm Delivery
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function deliverFile(submissionId) {
  document.getElementById('submissionId').value = submissionId;
  document.getElementById('deliveryModal').classList.remove('hidden');
}

function closeDeliveryModal() {
  document.getElementById('deliveryModal').classList.add('hidden');
}

document.getElementById('deliveryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submissionId = document.getElementById('submissionId').value;
  const deliveryNotes = document.getElementById('deliveryNotes').value;

  try {
    const response = await fetch(`/admin/delivery/${submissionId}/deliver`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ deliveryNotes })
    });

    const data = await response.json();
    if (data.success) {
      showToast('File delivered successfully!', 'success');
      closeDeliveryModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast('Error: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('Error delivering file:', error);
    showToast('An error occurred', 'error');
  }
});

function filterByStatus(status) {
  const url = new URL(window.location);
  url.searchParams.set('status', status);
  window.location = url.toString();
}

function viewHistory(submissionId) {
  window.location.href = `/admin/delivery/${submissionId}/history`;
}
</script>
