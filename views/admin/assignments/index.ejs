<section class="min-h-screen bg-slate-50 p-4 md:p-8">
  <div class="max-w-7xl mx-auto space-y-6">

    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-black text-slate-800">Writer Assignments</h1>
        <p class="text-slate-500 mt-1">Manage writer assignments and task allocations</p>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <p class="text-sm text-slate-500">Total Assignments</p>
          <p class="text-3xl font-black text-indigo-600"><%= total %></p>
        </div>
        <button onclick="showAssignModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center gap-2">
          <i class="fi fi-rr-plus"></i> Assign Writer
        </button>
      </div>
    </div>

    <!-- FILTERS CARD -->
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
      <h3 class="text-lg font-black text-slate-800 mb-4">Filters</h3>
      
      <form method="GET" action="/admin/assignments" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Status Filter -->
          <div>
            <label class="text-sm font-bold text-slate-700 mb-2 block">Status</label>
            <select name="status" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
              <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Statuses</option>
              <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="doable" <%= filters.status === 'doable' ? 'selected' : '' %>>Accepted (Doable)</option>
              <option value="not_doable" <%= filters.status === 'not_doable' ? 'selected' : '' %>>Rejected (Not Doable)</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 transition-all">
            <i class="fi fi-rr-search mr-2"></i>Apply Filters
          </button>
          <a href="/admin/assignments" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm hover:bg-slate-300 transition-all inline-block">
            <i class="fi fi-rr-arrow-rotate-left mr-2"></i>Reset
          </a>
        </div>
      </form>
    </div>

    <!-- ASSIGNMENTS TABLE -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">ID</th>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">Order / Topic</th>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">Writer</th>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">Client</th>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">Status</th>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">Assigned</th>
              <th class="px-6 py-4 text-left text-xs font-black text-slate-700 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <% if (records && records.length > 0) { %>
              <% records.forEach(record => { %>
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="px-6 py-4">
                    <span class="font-bold text-indigo-600">#<%= record.id %></span>
                  </td>
                  <td class="px-6 py-4">
                    <p class="font-bold text-slate-800"><%= record.query_code || 'N/A' %></p>
                    <p class="text-xs text-slate-500 truncate max-w-[200px]"><%= record.topic || 'No topic' %></p>
                  </td>
                  <td class="px-6 py-4">
                    <p class="font-semibold text-slate-800"><%= record.writer_name %></p>
                    <p class="text-xs text-slate-500"><%= record.writer_email %></p>
                  </td>
                  <td class="px-6 py-4">
                    <p class="font-semibold text-slate-800"><%= record.client_name || 'N/A' %></p>
                    <p class="text-xs text-slate-500"><%= record.client_email || '' %></p>
                  </td>
                  <td class="px-6 py-4">
                    <% 
                      const statusColors = {
                        'pending': 'bg-yellow-100 text-yellow-700',
                        'doable': 'bg-green-100 text-green-700',
                        'not_doable': 'bg-red-100 text-red-700'
                      };
                      const statusLabels = {
                        'pending': 'Pending',
                        'doable': 'Accepted',
                        'not_doable': 'Rejected'
                      };
                    %>
                    <span class="<%= statusColors[record.status] || 'bg-slate-100 text-slate-700' %> px-3 py-1 rounded-full text-xs font-bold">
                      <%= statusLabels[record.status] || record.status %>
                    </span>
                  </td>
                  <td class="px-6 py-4 text-sm text-slate-600">
                    <%= new Date(record.created_at).toLocaleDateString() %>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex gap-2">
                      <button onclick="viewAssignmentDetail(<%= record.id %>)" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1 rounded-lg text-xs font-bold transition-all">
                        <i class="fi fi-rr-eye mr-1"></i>View
                      </button>
                      <% if (record.status === 'pending' || record.status === 'not_doable') { %>
                        <button onclick="reassignWriter(<%= record.id %>)" class="bg-amber-100 text-amber-600 hover:bg-amber-200 px-3 py-1 rounded-lg text-xs font-bold transition-all">
                          <i class="fi fi-rr-refresh mr-1"></i>Reassign
                        </button>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="7" class="px-6 py-12 text-center text-slate-400">
                  <i class="fi fi-rr-inbox text-4xl block mb-2"></i>
                  <p>No assignments found</p>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PAGINATION -->
    <% if (pages > 1) { %>
      <div class="flex justify-center gap-2">
        <% for (let i = 1; i <= pages; i++) { %>
          <% if (i === page) { %>
            <span class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><%= i %></span>
          <% } else { %>
            <a href="/admin/assignments?page=<%= i - 1 %>&status=<%= filters.status %>" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-100 px-4 py-2 rounded-lg font-bold text-sm transition-all">
              <%= i %>
            </a>
          <% } %>
        <% } %>
      </div>
    <% } %>

  </div>
</section>

<!-- Assignment Modal -->
<div id="assignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-bold">Assign Writers to Order</h2>
      <button onclick="closeAssignModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
    </div>

    <form id="assignForm" class="p-6 space-y-4">
      <!-- Order Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Select Order</label>
        <input type="text" id="orderId" class="w-full border rounded px-3 py-2" placeholder="Enter order ID or search..." required>
        <div id="orderDropdown" class="mt-2 max-h-40 overflow-y-auto border rounded"></div>
      </div>

      <!-- Writers Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Select Writers</label>
        <div id="writersList" class="space-y-2 max-h-48 overflow-y-auto border rounded p-3">
          <!-- Writers will be loaded here -->
          <p class="text-gray-500">Loading writers...</p>
        </div>
      </div>

      <!-- Deadline -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Acceptance Deadline (Days)</label>
        <input type="number" id="deadline" value="7" min="1" max="30" class="w-full border rounded px-3 py-2">
      </div>

      <!-- Notes -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Assignment Notes</label>
        <textarea id="notes" class="w-full border rounded px-3 py-2 h-24" placeholder="Any special instructions or notes..."></textarea>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button type="button" onclick="closeAssignModal()" class="px-4 py-2 text-gray-700 border rounded hover:bg-gray-50">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
          Assign Writers
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let selectedWriterIds = [];

function showAssignModal() {
  document.getElementById('assignModal').classList.remove('hidden');
  loadAvailableWriters();
}

function closeAssignModal() {
  document.getElementById('assignModal').classList.add('hidden');
  selectedWriterIds = [];
}

async function loadAvailableWriters() {
  try {
    const response = await fetch('/admin/assignments/available-writers');
    const data = await response.json();
    
    const writersList = document.getElementById('writersList');
    writersList.innerHTML = data.writers.map(writer => `
      <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
        <input type="checkbox" value="${writer.user_id}" onchange="toggleWriter(${writer.user_id})" class="mr-3">
        <div>
          <div class="font-medium">${writer.full_name}</div>
          <div class="text-sm text-gray-600">${writer.email}</div>
        </div>
      </label>
    `).join('');
  } catch (error) {
    console.error('Error loading writers:', error);
    document.getElementById('writersList').innerHTML = '<p class="text-red-500">Error loading writers</p>';
  }
}

function toggleWriter(writerId) {
  if (selectedWriterIds.includes(writerId)) {
    selectedWriterIds = selectedWriterIds.filter(id => id !== writerId);
  } else {
    selectedWriterIds.push(writerId);
  }
}

document.getElementById('assignForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const orderId = document.getElementById('orderId').value;
  const deadline = document.getElementById('deadline').value;
  const notes = document.getElementById('notes').value;

  if (!orderId || selectedWriterIds.length === 0) {
    showToast('Please select an order and at least one writer', 'warning');
    return;
  }

  try {
    const response = await fetch('/admin/assignments/assign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId,
        writerIds: selectedWriterIds,
        deadline: parseInt(deadline),
        notes
      })
    });

    const data = await response.json();
    if (data.success) {
      showToast('Writers assigned successfully!', 'success');
      closeAssignModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast('Error: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('Error assigning writers:', error);
    showToast('An error occurred while assigning writers', 'error');
  }
});

async function viewAssignmentDetail(assignmentId) {
  try {
    const response = await fetch(`/admin/assignments/detail/${assignmentId}`);
    const data = await response.json();
    
    if (data.success) {
      // Show assignment detail in a modal
      showAssignmentDetailModal(data.assignment, data.submissions);
    } else {
      showToast('Failed to load assignment details: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('Error loading details', 'error');
  }
}

function showAssignmentDetailModal(assignment, submissions) {
  const submissionsHtml = submissions && submissions.length > 0 
    ? submissions.map(s => `
        <div class="border-b py-2">
          <p class="text-sm"><strong>Submission #${s.submission_id}</strong></p>
          <p class="text-xs text-gray-600">Status: ${s.status} | Date: ${new Date(s.created_at).toLocaleDateString()}</p>
          ${s.file_url ? `<a href="${s.file_url}" target="_blank" class="text-blue-600 text-xs">View File</a>` : ''}
        </div>
      `).join('')
    : '<p class="text-gray-500">No submissions yet</p>';

  const modalHtml = `
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
          <h2 class="text-xl font-bold">Assignment #${assignment.id}</h2>
          <button onclick="closeDetailModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 uppercase font-bold">Order</p>
              <p class="font-semibold">${assignment.query_code || 'N/A'}</p>
              <p class="text-sm text-gray-600">${assignment.paper_topic || ''}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase font-bold">Writer</p>
              <p class="font-semibold">${assignment.full_name}</p>
              <p class="text-sm text-gray-600">${assignment.email}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase font-bold">Status</p>
              <span class="px-2 py-1 rounded text-xs font-bold ${
                assignment.status === 'doable' ? 'bg-green-100 text-green-700' :
                assignment.status === 'not_doable' ? 'bg-red-100 text-red-700' :
                'bg-yellow-100 text-yellow-700'
              }">${assignment.status}</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase font-bold">Assigned</p>
              <p class="text-sm">${new Date(assignment.created_at).toLocaleDateString()}</p>
            </div>
          </div>
          ${assignment.comment ? `
            <div>
              <p class="text-xs text-gray-500 uppercase font-bold">Comment</p>
              <p class="text-sm bg-gray-50 p-2 rounded">${assignment.comment}</p>
            </div>
          ` : ''}
          <div>
            <p class="text-xs text-gray-500 uppercase font-bold mb-2">Submissions</p>
            ${submissionsHtml}
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDetailModal() {
  const modal = document.getElementById('detailModal');
  if (modal) modal.remove();
}

async function reassignWriter(assignmentId) {
  // First, load available writers
  let writers = [];
  try {
    const response = await fetch('/admin/assignments/available-writers');
    const data = await response.json();
    writers = data.writers || [];
  } catch (e) {
    showToast('Failed to load writers', 'error');
    return;
  }

  if (writers.length === 0) {
    showToast('No available writers found', 'warning');
    return;
  }

  // Show reassignment modal
  const modalHtml = `
    <div id="reassignModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
        <div class="bg-amber-500 text-white px-6 py-4 flex justify-between items-center rounded-t-lg">
          <h2 class="text-xl font-bold">Reassign Writer</h2>
          <button onclick="closeReassignModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Select New Writer</label>
            <select id="newWriterSelect" class="w-full border rounded px-3 py-2" required>
              <option value="">-- Select Writer --</option>
              ${writers.map(w => `<option value="${w.user_id}">${w.full_name} (${w.email})</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Reassignment</label>
            <textarea id="reassignReason" class="w-full border rounded px-3 py-2 h-20" placeholder="Why is this assignment being reassigned?"></textarea>
          </div>
          <div class="flex justify-end gap-2 pt-4 border-t">
            <button onclick="closeReassignModal()" class="px-4 py-2 text-gray-700 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="submitReassignment(${assignmentId})" class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600">Reassign</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeReassignModal() {
  const modal = document.getElementById('reassignModal');
  if (modal) modal.remove();
}

async function submitReassignment(assignmentId) {
  const newWriterId = document.getElementById('newWriterSelect').value;
  const reason = document.getElementById('reassignReason').value;

  if (!newWriterId) {
    showToast('Please select a new writer', 'warning');
    return;
  }

  try {
    const response = await fetch(`/admin/assignments/${assignmentId}/reassign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ newWriterId: parseInt(newWriterId), reason })
    });
    
    const data = await response.json();
    if (data.success) {
      showToast('Writer reassigned successfully!', 'success');
      closeReassignModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast('Error: ' + (data.error || 'Failed to reassign'), 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('An error occurred', 'error');
  }
}

async function viewAssignments(workCode) {
  // Load and display assignments for this work code
  window.location.href = '/admin/assignments/' + workCode;
}
</script>
